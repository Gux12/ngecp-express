(function(){var m=function(c){THREE.MeshBasicMaterial.call(this);this.depthWrite=this.depthTest=!1;this.side=THREE.FrontSide;this.transparent=!0;this.setValues(c);this.oldColor=this.color.clone();this.oldOpacity=this.opacity;this.highlight=function(a){a?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};m.prototype=Object.create(THREE.MeshBasicMaterial.prototype);m.prototype.constructor=m;var f=function(c){THREE.LineBasicMaterial.call(this);this.depthWrite=this.depthTest=!1;this.transparent=!0;this.linewidth=1;this.setValues(c);this.oldColor=this.color.clone();this.oldOpacity=this.opacity;this.highlight=function(a){a?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};f.prototype=Object.create(THREE.LineBasicMaterial.prototype);f.prototype.constructor=f;var k=new m({visible:!1,transparent:!1});THREE.TransformGizmo=function(){this.init=function(){THREE.Object3D.call(this);this.handles=new THREE.Object3D;this.pickers=new THREE.Object3D;this.planes=new THREE.Object3D;this.add(this.handles);this.add(this.pickers);this.add(this.planes);var c=new THREE.PlaneBufferGeometry(50,50,2,2),a=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),c={XY:new THREE.Mesh(c,a),YZ:new THREE.Mesh(c,a),XZ:new THREE.Mesh(c,a),XYZE:new THREE.Mesh(c,a)};this.activePlane=c.XYZE;c.YZ.rotation.set(0,Math.PI/2,0);c.XZ.rotation.set(-Math.PI/2,0,0);for(var g in c)c[g].name=g,this.planes.add(c[g]),this.planes[g]=c[g];c=function(a,c){for(var d in a)for(g=a[d].length;g--;){var q=a[d][g][0],b=a[d][g][1],h=a[d][g][2];q.name=d;b&&q.position.set(b[0],b[1],b[2]);h&&q.rotation.set(h[0],h[1],h[2]);c.add(q)}};c(this.handleGizmos,this.handles);c(this.pickerGizmos,this.pickers);this.traverse(function(a){if(a instanceof THREE.Mesh){a.updateMatrix();var c=a.geometry.clone();c.applyMatrix(a.matrix);a.geometry=c;a.position.set(0,0,0);a.rotation.set(0,0,0);a.scale.set(1,1,1)}})};this.highlight=function(c){this.traverse(function(a){a.material&&a.material.highlight&&(a.name===c?a.material.highlight(!0):a.material.highlight(!1))})}};THREE.TransformGizmo.prototype=Object.create(THREE.Object3D.prototype);THREE.TransformGizmo.prototype.constructor=THREE.TransformGizmo;THREE.TransformGizmo.prototype.update=function(c,a){var g=new THREE.Vector3(0,0,0),p=new THREE.Vector3(0,1,0),y=new THREE.Matrix4;this.traverse(function(d){-1!==d.name.search("E")?d.quaternion.setFromRotationMatrix(y.lookAt(a,g,p)):-1===d.name.search("X")&&-1===d.name.search("Y")&&-1===d.name.search("Z")||d.quaternion.setFromEuler(c)})};THREE.TransformGizmoTranslate=function(){THREE.TransformGizmo.call(this);var c=new THREE.Geometry,a=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));a.position.y=.5;a.updateMatrix();c.merge(a.geometry,a.matrix);a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32Attribute([0,0,0,1,0,0],3));var g=new THREE.BufferGeometry;g.addAttribute("position",new THREE.Float32Attribute([0,0,0,0,1,0],3));var p=new THREE.BufferGeometry;p.addAttribute("position",new THREE.Float32Attribute([0,0,0,0,0,1],3));this.handleGizmos={X:[[new THREE.Mesh(c,new m({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(a,new f({color:16711680}))]],Y:[[new THREE.Mesh(c,new m({color:65280})),[0,.5,0]],[new THREE.Line(g,new f({color:65280}))]],Z:[[new THREE.Mesh(c,new m({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(p,new f({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.1,0),new m({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new m({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new m({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new m({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]};this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),k),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),k),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),k),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),k)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),k),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),k),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),k),[.2,0,.2],[-Math.PI/2,0,0]]]};this.setActivePlane=function(a,d){var c=new THREE.Matrix4;d.applyMatrix4(c.getInverse(c.extractRotation(this.planes.XY.matrixWorld)));"X"===a&&(this.activePlane=this.planes.XY,Math.abs(d.y)>Math.abs(d.z)&&(this.activePlane=this.planes.XZ));"Y"===a&&(this.activePlane=this.planes.XY,Math.abs(d.x)>Math.abs(d.z)&&(this.activePlane=this.planes.YZ));"Z"===a&&(this.activePlane=this.planes.XZ,Math.abs(d.x)>Math.abs(d.y)&&(this.activePlane=this.planes.YZ));"XYZ"===a&&(this.activePlane=this.planes.XYZE);"XY"===a&&(this.activePlane=this.planes.XY);"YZ"===a&&(this.activePlane=this.planes.YZ);"XZ"===a&&(this.activePlane=this.planes.XZ)};this.init()};THREE.TransformGizmoTranslate.prototype=Object.create(THREE.TransformGizmo.prototype);THREE.TransformGizmoTranslate.prototype.constructor=THREE.TransformGizmoTranslate;THREE.TransformGizmoRotate=function(){THREE.TransformGizmo.call(this);var c=function(a,c,p){var y=new THREE.BufferGeometry,d=[];p=p?p:1;for(var q=0;q<=64*p;++q)"x"===c&&d.push(0,Math.cos(q/32*Math.PI)*a,Math.sin(q/32*Math.PI)*a),"y"===c&&d.push(Math.cos(q/32*Math.PI)*a,0,Math.sin(q/32*Math.PI)*a),"z"===c&&d.push(Math.sin(q/32*Math.PI)*a,Math.cos(q/32*Math.PI)*a,0);y.addAttribute("position",new THREE.Float32Attribute(d,3));return y};this.handleGizmos={X:[[new THREE.Line(new c(1,"x",.5),new f({color:16711680}))]],Y:[[new THREE.Line(new c(1,"y",.5),new f({color:65280}))]],Z:[[new THREE.Line(new c(1,"z",.5),new f({color:255}))]],E:[[new THREE.Line(new c(1.25,"z",1),new f({color:13421568}))]],XYZE:[[new THREE.Line(new c(1,"z",1),new f({color:7895160}))]]};this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),k),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),k),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(1,.12,4,12,Math.PI),k),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusGeometry(1.25,.12,2,24),k)]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]};this.setActivePlane=function(a){"E"===a&&(this.activePlane=this.planes.XYZE);"X"===a&&(this.activePlane=this.planes.YZ);"Y"===a&&(this.activePlane=this.planes.XZ);"Z"===a&&(this.activePlane=this.planes.XY)};this.update=function(a,c){THREE.TransformGizmo.prototype.update.apply(this,arguments);var p=new THREE.Matrix4,y=new THREE.Euler(0,0,1),d=new THREE.Quaternion,q=new THREE.Vector3(1,0,0),b=new THREE.Vector3(0,1,0),h=new THREE.Vector3(0,0,1),m=new THREE.Quaternion,k=new THREE.Quaternion,f=new THREE.Quaternion,w=c.clone();y.copy(this.planes.XY.rotation);d.setFromEuler(y);p.makeRotationFromQuaternion(d).getInverse(p);w.applyMatrix4(p);this.traverse(function(a){d.setFromEuler(y);"X"===a.name&&(m.setFromAxisAngle(q,Math.atan2(-w.y,w.z)),d.multiplyQuaternions(d,m),a.quaternion.copy(d));"Y"===a.name&&(k.setFromAxisAngle(b,Math.atan2(w.x,w.z)),d.multiplyQuaternions(d,k),a.quaternion.copy(d));"Z"===a.name&&(f.setFromAxisAngle(h,Math.atan2(w.y,w.x)),d.multiplyQuaternions(d,f),a.quaternion.copy(d))})};this.init()};THREE.TransformGizmoRotate.prototype=Object.create(THREE.TransformGizmo.prototype);THREE.TransformGizmoRotate.prototype.constructor=THREE.TransformGizmoRotate;THREE.TransformGizmoScale=function(){THREE.TransformGizmo.call(this);var c=new THREE.Geometry,a=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));a.position.y=.5;a.updateMatrix();c.merge(a.geometry,a.matrix);a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32Attribute([0,0,0,1,0,0],3));var g=new THREE.BufferGeometry;g.addAttribute("position",new THREE.Float32Attribute([0,0,0,0,1,0],3));var p=new THREE.BufferGeometry;p.addAttribute("position",new THREE.Float32Attribute([0,0,0,0,0,1],3));this.handleGizmos={X:[[new THREE.Mesh(c,new m({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(a,new f({color:16711680}))]],Y:[[new THREE.Mesh(c,new m({color:65280})),[0,.5,0]],[new THREE.Line(g,new f({color:65280}))]],Z:[[new THREE.Mesh(c,new m({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(p,new f({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125),new m({color:16777215,opacity:.25}))]]};this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),k),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),k),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),k),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.4,.4,.4),k)]]};this.setActivePlane=function(a,c){var g=new THREE.Matrix4;c.applyMatrix4(g.getInverse(g.extractRotation(this.planes.XY.matrixWorld)));"X"===a&&(this.activePlane=this.planes.XY,Math.abs(c.y)>Math.abs(c.z)&&(this.activePlane=this.planes.XZ));"Y"===a&&(this.activePlane=this.planes.XY,Math.abs(c.x)>Math.abs(c.z)&&(this.activePlane=this.planes.YZ));"Z"===a&&(this.activePlane=this.planes.XZ,Math.abs(c.x)>Math.abs(c.y)&&(this.activePlane=this.planes.YZ));"XYZ"===a&&(this.activePlane=this.planes.XYZE)};this.init()};THREE.TransformGizmoScale.prototype=Object.create(THREE.TransformGizmo.prototype);THREE.TransformGizmoScale.prototype.constructor=THREE.TransformGizmoScale;THREE.TransformControls=function(c,a){function g(a){if(void 0!==b.object&&!0!==k&&(void 0===a.button||0===a.button)){var c=q(a.changedTouches?a.changedTouches[0]:a,f[h].pickers.children),d=null;c&&(d=c.object.name,a.preventDefault());b.axis!==d&&(b.axis=d,b.update(),b.dispatchEvent(G))}}function p(a){if(void 0!==b.object&&!0!==k&&(void 0===a.button||0===a.button)){var c=a.changedTouches?a.changedTouches[0]:a;if(0===c.button||void 0===c.button){var d=q(c,f[h].pickers.children);d&&(a.preventDefault(),a.stopPropagation(),b.dispatchEvent(X),b.axis=d.object.name,b.update(),D.copy(J).sub(B).normalize(),f[h].setActivePlane(b.axis,D),a=q(c,[f[h].activePlane]))&&(Q.copy(b.object.position),C.copy(b.object.scale),R.extractRotation(b.object.matrix),x.extractRotation(b.object.matrixWorld),H.extractRotation(b.object.parent.matrixWorld),I.setFromMatrixScale(u.getInverse(b.object.parent.matrixWorld)),K.copy(a.point))}k=!0}}function m(a){if(void 0!==b.object&&null!==b.axis&&!1!==k&&(void 0===a.button||0===a.button)){var c=q(a.changedTouches?a.changedTouches[0]:a,[f[h].activePlane]);if(!1!==c){a.preventDefault();a.stopPropagation();e.copy(c.point);if("translate"===h){e.sub(K);e.multiply(I);"local"===b.space&&(e.applyMatrix4(u.getInverse(x)),-1===b.axis.search("X")&&(e.x=0),-1===b.axis.search("Y")&&(e.y=0),-1===b.axis.search("Z")&&(e.z=0),e.applyMatrix4(R),b.object.position.copy(Q),b.object.position.add(e));if("world"===b.space||-1!==b.axis.search("XYZ"))-1===b.axis.search("X")&&(e.x=0),-1===b.axis.search("Y")&&(e.y=0),-1===b.axis.search("Z")&&(e.z=0),e.applyMatrix4(u.getInverse(H)),b.object.position.copy(Q),b.object.position.add(e);null!==b.translationSnap&&("local"===b.space&&b.object.position.applyMatrix4(u.getInverse(x)),-1!==b.axis.search("X")&&(b.object.position.x=Math.round(b.object.position.x/b.translationSnap)*b.translationSnap),-1!==b.axis.search("Y")&&(b.object.position.y=Math.round(b.object.position.y/b.translationSnap)*b.translationSnap),-1!==b.axis.search("Z")&&(b.object.position.z=Math.round(b.object.position.z/b.translationSnap)*b.translationSnap),"local"===b.space&&b.object.position.applyMatrix4(x))}else"scale"===h?(e.sub(K),e.multiply(I),"local"===b.space&&("XYZ"===b.axis?(z=1+e.y/50,b.object.scale.x=C.x*z,b.object.scale.y=C.y*z,b.object.scale.z=C.z*z):(e.applyMatrix4(u.getInverse(x)),"X"===b.axis&&(b.object.scale.x=C.x*(1+e.x/50)),"Y"===b.axis&&(b.object.scale.y=C.y*(1+e.y/50)),"Z"===b.axis&&(b.object.scale.z=C.z*(1+e.z/50))))):"rotate"===h&&(e.sub(B),e.multiply(I),l.copy(K).sub(B),l.multiply(I),"E"===b.axis?(e.applyMatrix4(u.getInverse(S)),l.applyMatrix4(u.getInverse(S)),r.set(Math.atan2(e.z,e.y),Math.atan2(e.x,e.z),Math.atan2(e.y,e.x)),t.set(Math.atan2(l.z,l.y),Math.atan2(l.x,l.z),Math.atan2(l.y,l.x)),n.setFromRotationMatrix(u.getInverse(H)),L.setFromAxisAngle(D,r.z-t.z),v.setFromRotationMatrix(x),n.multiplyQuaternions(n,L),n.multiplyQuaternions(n,v),b.object.quaternion.copy(n)):"XYZE"===b.axis?(L.setFromEuler(e.clone().cross(l).normalize()),n.setFromRotationMatrix(u.getInverse(H)),A.setFromAxisAngle(L,-e.clone().angleTo(l)),v.setFromRotationMatrix(x),n.multiplyQuaternions(n,A),n.multiplyQuaternions(n,v),b.object.quaternion.copy(n)):"local"===b.space?(e.applyMatrix4(u.getInverse(x)),l.applyMatrix4(u.getInverse(x)),r.set(Math.atan2(e.z,e.y),Math.atan2(e.x,e.z),Math.atan2(e.y,e.x)),t.set(Math.atan2(l.z,l.y),Math.atan2(l.x,l.z),Math.atan2(l.y,l.x)),v.setFromRotationMatrix(R),null!==b.rotationSnap?(A.setFromAxisAngle(M,Math.round((r.x-t.x)/b.rotationSnap)*b.rotationSnap),E.setFromAxisAngle(N,Math.round((r.y-t.y)/b.rotationSnap)*b.rotationSnap),F.setFromAxisAngle(O,Math.round((r.z-t.z)/b.rotationSnap)*b.rotationSnap)):(A.setFromAxisAngle(M,r.x-t.x),E.setFromAxisAngle(N,r.y-t.y),F.setFromAxisAngle(O,r.z-t.z)),"X"===b.axis&&v.multiplyQuaternions(v,A),"Y"===b.axis&&v.multiplyQuaternions(v,E),"Z"===b.axis&&v.multiplyQuaternions(v,F),b.object.quaternion.copy(v)):"world"===b.space&&(r.set(Math.atan2(e.z,e.y),Math.atan2(e.x,e.z),Math.atan2(e.y,e.x)),t.set(Math.atan2(l.z,l.y),Math.atan2(l.x,l.z),Math.atan2(l.y,l.x)),n.setFromRotationMatrix(u.getInverse(H)),null!==b.rotationSnap?(A.setFromAxisAngle(M,Math.round((r.x-t.x)/b.rotationSnap)*b.rotationSnap),E.setFromAxisAngle(N,Math.round((r.y-t.y)/b.rotationSnap)*b.rotationSnap),F.setFromAxisAngle(O,Math.round((r.z-t.z)/b.rotationSnap)*b.rotationSnap)):(A.setFromAxisAngle(M,r.x-t.x),E.setFromAxisAngle(N,r.y-t.y),F.setFromAxisAngle(O,r.z-t.z)),v.setFromRotationMatrix(x),"X"===b.axis&&n.multiplyQuaternions(n,A),"Y"===b.axis&&n.multiplyQuaternions(n,E),"Z"===b.axis&&n.multiplyQuaternions(n,F),n.multiplyQuaternions(n,v),b.object.quaternion.copy(n)));b.update();b.dispatchEvent(G);b.dispatchEvent(Y)}}}function d(a){if(void 0===a.button||0===a.button)k&&null!==b.axis&&(T.mode=h,b.dispatchEvent(T)),k=!1,g(a)}function q(b,d){var e=a.getBoundingClientRect();U.set((b.clientX-e.left)/e.width*2-1,-((b.clientY-e.top)/e.height*2)+1);V.setFromCamera(U,c);b=V.intersectObjects(d,!0);return b[0]?b[0]:!1}THREE.Object3D.call(this);a=void 0!==a?a:document;this.object=void 0;this.visible=!1;this.rotationSnap=this.translationSnap=null;this.space="world";this.size=1;this.axis=null;var b=this,h="translate",k=!1,f={translate:new THREE.TransformGizmoTranslate,rotate:new THREE.TransformGizmoRotate,scale:new THREE.TransformGizmoScale},P;for(P in f){var w=f[P];w.visible=P===h;this.add(w)}var G={type:"change"},X={type:"mouseDown"},T={type:"mouseUp",mode:h},Y={type:"objectChange"},V=new THREE.Raycaster,U=new THREE.Vector2,e=new THREE.Vector3,K=new THREE.Vector3,r=new THREE.Vector3,t=new THREE.Vector3,z=1,S=new THREE.Matrix4,D=new THREE.Vector3,u=new THREE.Matrix4,l=new THREE.Vector3,n=new THREE.Quaternion,M=new THREE.Vector3(1,0,0),N=new THREE.Vector3(0,1,0),O=new THREE.Vector3(0,0,1),v=new THREE.Quaternion,A=new THREE.Quaternion,E=new THREE.Quaternion,F=new THREE.Quaternion,L=new THREE.Quaternion,Q=new THREE.Vector3,C=new THREE.Vector3,R=new THREE.Matrix4,H=new THREE.Matrix4,I=new THREE.Vector3,B=new THREE.Vector3,W=new THREE.Euler,x=new THREE.Matrix4,J=new THREE.Vector3,Z=new THREE.Euler;a.addEventListener("mousedown",p,!1);a.addEventListener("touchstart",p,!1);a.addEventListener("mousemove",g,!1);a.addEventListener("touchmove",g,!1);a.addEventListener("mousemove",m,!1);a.addEventListener("touchmove",m,!1);a.addEventListener("mouseup",d,!1);a.addEventListener("mouseout",d,!1);a.addEventListener("touchend",d,!1);a.addEventListener("touchcancel",d,!1);a.addEventListener("touchleave",d,!1);this.dispose=function(){a.removeEventListener("mousedown",p);a.removeEventListener("touchstart",p);a.removeEventListener("mousemove",g);a.removeEventListener("touchmove",g);a.removeEventListener("mousemove",m);a.removeEventListener("touchmove",m);a.removeEventListener("mouseup",d);a.removeEventListener("mouseout",d);a.removeEventListener("touchend",d);a.removeEventListener("touchcancel",d);a.removeEventListener("touchleave",d)};this.attach=function(a){this.object=a;this.visible=!0;this.update()};this.detach=function(){this.object=void 0;this.visible=!1;this.axis=null};this.getMode=function(){return h};this.setMode=function(a){h=a?a:h;"scale"===h&&(b.space="local");for(var c in f)f[c].visible=c===h;this.update();b.dispatchEvent(G)};this.setTranslationSnap=function(a){b.translationSnap=a};this.setRotationSnap=function(a){b.rotationSnap=a};this.setSize=function(a){b.size=a;this.update();b.dispatchEvent(G)};this.setSpace=function(a){b.space=a;this.update();b.dispatchEvent(G)};this.update=function(){void 0!==b.object&&(b.object.updateMatrixWorld(),B.setFromMatrixPosition(b.object.matrixWorld),W.setFromRotationMatrix(u.extractRotation(b.object.matrixWorld)),c.updateMatrixWorld(),J.setFromMatrixPosition(c.matrixWorld),Z.setFromRotationMatrix(u.extractRotation(c.matrixWorld)),z=B.distanceTo(J)/6*b.size,this.position.copy(B),this.scale.set(z,z,z),D.copy(J).sub(B).normalize(),"local"===b.space?f[h].update(W,D):"world"===b.space&&f[h].update(new THREE.Euler,D),f[h].highlight(b.axis))}};THREE.TransformControls.prototype=Object.create(THREE.Object3D.prototype);THREE.TransformControls.prototype.constructor=THREE.TransformControls})();